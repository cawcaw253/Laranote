version: '2.1'

orbs:
  aws-cli: circleci/aws-cli@2.0
  aws-ecr: circleci/aws-ecr@7.0.0

executors:
  my-executor:
    docker:
      - image: circleci/php:8.0-fpm

commands:
  build-push:
    description: "Build << parameters.repo >> image and push to ECR"
    parameters:
      dockerfile:
        type: string
      repo:
        type: string
      tag:
        type: string
    steps:
      - aws-ecr/build-and-push-image:
          dockerfile: << parameters.dockerfile >>
          repo: << parameters.repo >>
          tag: << parameters.tag >>
          path: "."

jobs:
  # init:
  #   executor: my-executor
  #   steps:
  #     - checkout
  #     - run:
  #         command: |
  #           cd src
  #           ls -la
  #           cp .env.prod .env
  #           composer install
  build-deploy-nginx:
    executor: my-executor
    steps:
      - checkout
      - setup_remote_docker
      - run:
          command: |
            sed -i -e "s/app/127.0.0.1/g" ./docker/nginx/default.conf
            cat ./docker/nginx/default.conf
      - build-push:
          dockerfile: "docker/nginx/Dockerfile"
          repo: "laranote/nginx"
          tag: "latest,${CIRCLE_SHA1}"
  build-deploy-app:
    executor: my-executor
    steps:
      - checkout
      - run:
          command: |
            cd src
            cp .env.prod .env
            composer install
      - setup_remote_docker
      - build-push:
          dockerfile: "docker/app/Dockerfile"
          repo: "laranote/app"
          tag: "latest,${CIRCLE_SHA1}"
      # - build-push:
      #     dockerfile: "docker/nginx/Dockerfile"
      #     repo: "laranote/nginx"
      #     tag: "latest,${CIRCLE_SHA1}"

workflows:
  version: '2.1'
  laranote:
    jobs:
      # - init
      - build-deploy-nginx
      - build-deploy-app
      # - aws-ecr/build-and-push-image:
      #     dockerfile: "docker/app/Dockerfile"
      #     repo: "laranote/app"
      #     tag: 'latest'
      #     # filters:
      #     #   branches:
      #     #     only:
      #     #       - deployments
      # - aws-ecr/build-and-push-image:
      #     dockerfile: "docker/nginx/Dockerfile"
      #     repo: "laranote/nginx"
      #     tag: 'latest'
      #     # filters:
      #     #   branches:
      #     #     only:
      #     #       - deployments